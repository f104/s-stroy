/**
 * jQuery CSS Customizable Scrollbar
 *
 * Copyright 2015, Yuriy Khabarov
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * If you found bug, please contact me via email <13real008@gmail.com>
 *
 * @author Yuriy Khabarov aka Gromo
 * @version 0.2.11
 * @url https://github.com/gromo/jquery.scrollbar/
 *
 */
;
(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define(['jquery'], factory);
    } else if (typeof exports !== "undefined") {
        factory(require('jquery'));
    } else {
        factory(root.jQuery);
    }
}(this, function ($) {
    'use strict';

    // init flags & variables
    var debug = false;

    var browser = {
        data: {
            index: 0,
            name: 'scrollbar'
        },
        firefox: /firefox/i.test(navigator.userAgent),
        macosx: /mac/i.test(navigator.platform),
        msedge: /edge\/\d+/i.test(navigator.userAgent),
        msie: /(msie|trident)/i.test(navigator.userAgent),
        mobile: /android|webos|iphone|ipad|ipod|blackberry/i.test(navigator.userAgent),
        overlay: null,
        scroll: null,
        scrolls: [],
        webkit: /webkit/i.test(navigator.userAgent) && !/edge\/\d+/i.test(navigator.userAgent)
    };

    browser.scrolls.add = function (instance) {
        this.remove(instance).push(instance);
    };
    browser.scrolls.remove = function (instance) {
        while ($.inArray(instance, this) >= 0) {
            this.splice($.inArray(instance, this), 1);
        }
        return this;
    };

    var defaults = {
        autoScrollSize: true, // automatically calculate scrollsize
        autoUpdate: true, // update scrollbar if content/container size changed
        debug: false, // debug mode
        disableBodyScroll: false, // disable body scroll if mouse over container
        duration: 200, // scroll animate duration in ms
        ignoreMobile: false, // ignore mobile devices
        ignoreOverlay: false, // ignore browsers with overlay scrollbars (mobile, MacOS)
        isRtl: false, // is RTL
        scrollStep: 30, // scroll step for scrollbar arrows
        showArrows: false, // add class to show arrows
        stepScrolling: true, // when scrolling to scrollbar mousedown position

        scrollx: null, // horizontal scroll element
        scrolly: null, // vertical scroll element

        onDestroy: null, // callback function on destroy,
        onFallback: null, // callback function if scrollbar is not initialized
        onInit: null, // callback function on first initialization
        onScroll: null, // callback function on content scrolling
        onUpdate: null            // callback function on init/resize (before scrollbar size calculation)
    };


    var BaseScrollbar = function (container) {

        if (!browser.scroll) {
            browser.overlay = isScrollOverlaysContent();
            browser.scroll = getBrowserScrollSize();
            updateScrollbars();

            $(window).resize(function () {
                var forceUpdate = false;
                if (browser.scroll && (browser.scroll.height || browser.scroll.width)) {
                    var scroll = getBrowserScrollSize();
                    if (scroll.height !== browser.scroll.height || scroll.width !== browser.scroll.width) {
                        browser.scroll = scroll;
                        forceUpdate = true; // handle page zoom
                    }
                }
                updateScrollbars(forceUpdate);
            });
        }

        this.container = container;
        this.namespace = '.scrollbar_' + browser.data.index++;
        this.options = $.extend({}, defaults, window.jQueryScrollbarOptions || {});
        this.scrollTo = null;
        this.scrollx = {};
        this.scrolly = {};

        container.data(browser.data.name, this);
        browser.scrolls.add(this);
    };

    BaseScrollbar.prototype = {
        destroy: function () {

            if (!this.wrapper) {
                return;
            }

            this.container.removeData(browser.data.name);
            browser.scrolls.remove(this);

            // init variables
            var scrollLeft = this.container.scrollLeft();
            var scrollTop = this.container.scrollTop();

            this.container.insertBefore(this.wrapper).css({
                "height": "",
                "margin": "",
                "max-height": ""
            })
                .removeClass('scroll-content scroll-scrollx_visible scroll-scrolly_visible')
                .off(this.namespace)
                .scrollLeft(scrollLeft)
                .scrollTop(scrollTop);

            this.scrollx.scroll.removeClass('scroll-scrollx_visible').find('div').addBack().off(this.namespace);
            this.scrolly.scroll.removeClass('scroll-scrolly_visible').find('div').addBack().off(this.namespace);

            this.wrapper.remove();

            $(document).add('body').off(this.namespace);

            if ($.isFunction(this.options.onDestroy)) {
                this.options.onDestroy.apply(this, [this.container]);
            }
        },
        init: function (options) {

            // init variables
            var S = this,
                c = this.container,
                cw = this.containerWrapper || c,
                namespace = this.namespace,
                o = $.extend(this.options, options || {}),
                s = {x: this.scrollx, y: this.scrolly},
            w = this.wrapper,
                cssOptions = {};

            var initScroll = {
                scrollLeft: c.scrollLeft(),
                scrollTop: c.scrollTop()
            };

            // do not init if in ignorable browser
            if ((browser.mobile && o.ignoreMobile)
                || (browser.overlay && o.ignoreOverlay)
                || (browser.macosx && !browser.webkit) // still required to ignore nonWebKit browsers on Mac
                ) {
                if ($.isFunction(o.onFallback)) {
                    o.onFallback.apply(this, [c]);
                }
                return false;
            }

            // init scroll container
            if (!w) {
                this.wrapper = w = $('<div>').addClass('scroll-wrapper').addClass(c.attr('class'))
                    .css('position', c.css('position') === 'absolute' ? 'absolute' : 'relative')
                    .insertBefore(c).append(c);

                if (o.isRtl) {
                    w.addClass('scroll--rtl');
                }

                if (c.is('textarea')) {
                    this.containerWrapper = cw = $('<div>').insertBefore(c).append(c);
                    w.addClass('scroll-textarea');
                }

                cssOptions = {
                    "height": "auto",
                    "margin-bottom": browser.scroll.height * -1 + 'px',
                    "max-height": ""
                };
                cssOptions[o.isRtl ? 'margin-left' : 'margin-right'] = browser.scroll.width * -1 + 'px';

                cw.addClass('scroll-content').css(cssOptions);

                c.on('scroll' + namespace, function (event) {
                    var scrollLeft = c.scrollLeft();
                    var scrollTop = c.scrollTop();
                    if (o.isRtl) {
                        // webkit   0:100
                        // ie/edge  100:0
                        // firefox -100:0
                        switch (true) {
                            case browser.firefox:
                                scrollLeft = Math.abs(scrollLeft);
                            case browser.msedge || browser.msie:
                                scrollLeft = c[0].scrollWidth - c[0].clientWidth - scrollLeft;
                                break;
                        }
                    }
                    if ($.isFunction(o.onScroll)) {
                        o.onScroll.call(S, {
                            maxScroll: s.y.maxScrollOffset,
                            scroll: scrollTop,
                            size: s.y.size,
                            visible: s.y.visible
                        }, {
                            maxScroll: s.x.maxScrollOffset,
                            scroll: scrollLeft,
                            size: s.x.size,
                            visible: s.x.visible
                        });
                    }
                    s.x.isVisible && s.x.scroll.bar.css('left', scrollLeft * s.x.kx + 'px');
                    s.y.isVisible && s.y.scroll.bar.css('top', scrollTop * s.y.kx + 'px');
                });

                /* prevent native scrollbars to be visible on #anchor click */
                w.on('scroll' + namespace, function () {
                    w.scrollTop(0).scrollLeft(0);
                });

                if (o.disableBodyScroll) {
                    var handleMouseScroll = function (event) {
                        isVerticalScroll(event) ?
                            s.y.isVisible && s.y.mousewheel(event) :
                            s.x.isVisible && s.x.mousewheel(event);
                    };
                    w.on('MozMousePixelScroll' + namespace, handleMouseScroll);
                    w.on('mousewheel' + namespace, handleMouseScroll);

                    if (browser.mobile) {
                        w.on('touchstart' + namespace, function (event) {
                            var touch = event.originalEvent.touches && event.originalEvent.touches[0] || event;
                            var originalTouch = {
                                pageX: touch.pageX,
                                pageY: touch.pageY
                            };
                            var originalScroll = {
                                left: c.scrollLeft(),
                                top: c.scrollTop()
                            };
                            $(document).on('touchmove' + namespace, function (event) {
                                var touch = event.originalEvent.targetTouches && event.originalEvent.targetTouches[0] || event;
                                c.scrollLeft(originalScroll.left + originalTouch.pageX - touch.pageX);
                                c.scrollTop(originalScroll.top + originalTouch.pageY - touch.pageY);
                                event.preventDefault();
                            });
                            $(document).on('touchend' + namespace, function () {
                                $(document).off(namespace);
                            });
                        });
                    }
                }
                if ($.isFunction(o.onInit)) {
                    o.onInit.apply(this, [c]);
                }
            } else {
                cssOptions = {
                    "height": "auto",
                    "margin-bottom": browser.scroll.height * -1 + 'px',
                    "max-height": ""
                };
                cssOptions[o.isRtl ? 'margin-left' : 'margin-right'] = browser.scroll.width * -1 + 'px';
                cw.css(cssOptions);
            }

            // init scrollbars & recalculate sizes
            $.each(s, function (d, scrollx) {

                var scrollCallback = null;
                var scrollForward = 1;
                var scrollOffset = (d === 'x') ? 'scrollLeft' : 'scrollTop';
                var scrollStep = o.scrollStep;
                var scrollTo = function () {
                    var currentOffset = c[scrollOffset]();
                    c[scrollOffset](currentOffset + scrollStep);
                    if (scrollForward == 1 && (currentOffset + scrollStep) >= scrollToValue)
                        currentOffset = c[scrollOffset]();
                    if (scrollForward == -1 && (currentOffset + scrollStep) <= scrollToValue)
                        currentOffset = c[scrollOffset]();
                    if (c[scrollOffset]() == currentOffset && scrollCallback) {
                        scrollCallback();
                    }
                }
                var scrollToValue = 0;

                if (!scrollx.scroll) {

                    scrollx.scroll = S._getScroll(o['scroll' + d]).addClass('scroll-' + d);

                    if (o.showArrows) {
                        scrollx.scroll.addClass('scroll-element_arrows_visible');
                    }

                    scrollx.mousewheel = function (event) {

                        if (!scrollx.isVisible || (d === 'x' && isVerticalScroll(event))) {
                            return true;
                        }
                        if (d === 'y' && !isVerticalScroll(event)) {
                            s.x.mousewheel(event);
                            return true;
                        }

                        var delta = event.originalEvent.wheelDelta * -1 || event.originalEvent.detail;
                        var maxScrollValue = scrollx.size - scrollx.visible - scrollx.offset;

                        // fix new mozilla
                        if (!delta) {
                            if (d === 'x' && !!event.originalEvent.deltaX) {
                                delta = event.originalEvent.deltaX * 40;
                            } else if (d === 'y' && !!event.originalEvent.deltaY) {
                                delta = event.originalEvent.deltaY * 40;
                            }
                        }

                        if ((delta > 0 && scrollToValue < maxScrollValue) || (delta < 0 && scrollToValue > 0)) {
                            scrollToValue = scrollToValue + delta;
                            if (scrollToValue < 0)
                                scrollToValue = 0;
                            if (scrollToValue > maxScrollValue)
                                scrollToValue = maxScrollValue;

                            S.scrollTo = S.scrollTo || {};
                            S.scrollTo[scrollOffset] = scrollToValue;
                            setTimeout(function () {
                                if (S.scrollTo) {
                                    c.stop().animate(S.scrollTo, 240, 'linear', function () {
                                        scrollToValue = c[scrollOffset]();
                                    });
                                    S.scrollTo = null;
                                }
                            }, 1);
                        }

                        event.preventDefault();
                        return false;
                    };

                    scrollx.scroll
                        .on('MozMousePixelScroll' + namespace, scrollx.mousewheel)
                        .on('mousewheel' + namespace, scrollx.mousewheel)
                        .on('mouseenter' + namespace, function () {
                            scrollToValue = c[scrollOffset]();
                        });

                    // handle arrows & scroll inner mousedown event
                    scrollx.scroll.find('.scroll-arrow, .scroll-element_track')
                        .on('mousedown' + namespace, function (event) {

                            if (event.which != 1) // lmb
                                return true;

                            scrollForward = 1;

                            var data = {
                                eventOffset: event[(d === 'x') ? 'pageX' : 'pageY'],
                                maxScrollValue: scrollx.size - scrollx.visible - scrollx.offset,
                                scrollbarOffset: scrollx.scroll.bar.offset()[(d === 'x') ? 'left' : 'top'],
                                scrollbarSize: scrollx.scroll.bar[(d === 'x') ? 'outerWidth' : 'outerHeight']()
                            };
                            var timeout = 0, timer = 0;

                            if ($(this).hasClass('scroll-arrow')) {
                                scrollForward = $(this).hasClass("scroll-arrow_more") ? 1 : -1;
                                scrollStep = o.scrollStep * scrollForward;
                                scrollToValue = scrollForward > 0 ? data.maxScrollValue : 0;
                                if (o.isRtl) {
                                    switch(true){
                                        case browser.firefox:
                                            scrollToValue = scrollForward > 0 ? 0: data.maxScrollValue * -1;
                                            break;
                                        case browser.msie || browser.msedge:
                                            break;
                                    }
                                }
                            } else {
                                scrollForward = (data.eventOffset > (data.scrollbarOffset + data.scrollbarSize) ? 1
                                    : (data.eventOffset < data.scrollbarOffset ? -1 : 0));
                                if(d === 'x' && o.isRtl && (browser.msie || browser.msedge))
                                    scrollForward = scrollForward * -1;
                                scrollStep = Math.round(scrollx.visible * 0.75) * scrollForward;
                                scrollToValue = (data.eventOffset - data.scrollbarOffset -
                                    (o.stepScrolling ? (scrollForward == 1 ? data.scrollbarSize : 0)
                                        : Math.round(data.scrollbarSize / 2)));
                                scrollToValue = c[scrollOffset]() + (scrollToValue / scrollx.kx);
                            }

                            S.scrollTo = S.scrollTo || {};
                            S.scrollTo[scrollOffset] = o.stepScrolling ? c[scrollOffset]() + scrollStep : scrollToValue;

                            if (o.stepScrolling) {
                                scrollCallback = function () {
                                    scrollToValue = c[scrollOffset]();
                                    clearInterval(timer);
                                    clearTimeout(timeout);
                                    timeout = 0;
                                    timer = 0;
                                };
                                timeout = setTimeout(function () {
                                    timer = setInterval(scrollTo, 40);
                                }, o.duration + 100);
                            }

                            setTimeout(function () {
                                if (S.scrollTo) {
                                    c.animate(S.scrollTo, o.duration);
                                    S.scrollTo = null;
                                }
                            }, 1);

                            return S._handleMouseDown(scrollCallback, event);
                        });

                    // handle scrollbar drag'n'drop
                    scrollx.scroll.bar.on('mousedown' + namespace, function (event) {

                        if (event.which != 1) // lmb
                            return true;

                        var eventPosition = event[(d === 'x') ? 'pageX' : 'pageY'];
                        var initOffset = c[scrollOffset]();

                        scrollx.scroll.addClass('scroll-draggable');

                        $(document).on('mousemove' + namespace, function (event) {
                            var diff = parseInt((event[(d === 'x') ? 'pageX' : 'pageY'] - eventPosition) / scrollx.kx, 10);
                            if (d === 'x' && o.isRtl && (browser.msie || browser.msedge))
                                diff = diff * -1;
                            c[scrollOffset](initOffset + diff);
                        });

                        return S._handleMouseDown(function () {
                            scrollx.scroll.removeClass('scroll-draggable');
                            scrollToValue = c[scrollOffset]();
                        }, event);
                    });
                }
            });

            // remove classes & reset applied styles
            $.each(s, function (d, scrollx) {
                var scrollClass = 'scroll-scroll' + d + '_visible';
                var scrolly = (d == "x") ? s.y : s.x;

                scrollx.scroll.removeClass(scrollClass);
                scrolly.scroll.removeClass(scrollClass);
                cw.removeClass(scrollClass);
            });

            // calculate init sizes
            $.each(s, function (d, scrollx) {
                $.extend(scrollx, (d == "x") ? {
                    offset: parseInt(c.css('left'), 10) || 0,
                    size: c.prop('scrollWidth'),
                    visible: w.width()
                } : {
                    offset: parseInt(c.css('top'), 10) || 0,
                    size: c.prop('scrollHeight'),
                    visible: w.height()
                });
            });

            // update scrollbar visibility/dimensions
            this._updateScroll('x', this.scrollx);
            this._updateScroll('y', this.scrolly);

            if ($.isFunction(o.onUpdate)) {
                o.onUpdate.apply(this, [c]);
            }

            // calculate scroll size
            $.each(s, function (d, scrollx) {

                var cssOffset = (d === 'x') ? 'left' : 'top';
                var cssFullSize = (d === 'x') ? 'outerWidth' : 'outerHeight';
                var cssSize = (d === 'x') ? 'width' : 'height';
                var offset = parseInt(c.css(cssOffset), 10) || 0;

                var AreaSize = scrollx.size;
                var AreaVisible = scrollx.visible + offset;

                var scrollSize = scrollx.scroll.size[cssFullSize]() + (parseInt(scrollx.scroll.size.css(cssOffset), 10) || 0);

                if (o.autoScrollSize) {
                    scrollx.scrollbarSize = parseInt(scrollSize * AreaVisible / AreaSize, 10);
                    scrollx.scroll.bar.css(cssSize, scrollx.scrollbarSize + 'px');
                }

                scrollx.scrollbarSize = scrollx.scroll.bar[cssFullSize]();
                scrollx.kx = ((scrollSize - scrollx.scrollbarSize) / (AreaSize - AreaVisible)) || 1;
                scrollx.maxScrollOffset = AreaSize - AreaVisible;
            });

            c.scrollLeft(initScroll.scrollLeft).scrollTop(initScroll.scrollTop).trigger('scroll');
        },
        /**
         * Get scrollx/scrolly object
         *
         * @param {Mixed} scroll
         * @returns {jQuery} scroll object
         */
        _getScroll: function (scroll) {
            var types = {
                advanced: [
                    '<div class="scroll-element">',
                    '<div class="scroll-element_corner"></div>',
                    '<div class="scroll-arrow scroll-arrow_less"></div>',
                    '<div class="scroll-arrow scroll-arrow_more"></div>',
                    '<div class="scroll-element_outer">',
                    '<div class="scroll-element_size"></div>', // required! used for scrollbar size calculation !
                    '<div class="scroll-element_inner-wrapper">',
                    '<div class="scroll-element_inner scroll-element_track">', // used for handling scrollbar click
                    '<div class="scroll-element_inner-bottom"></div>',
                    '</div>',
                    '</div>',
                    '<div class="scroll-bar">', // required
                    '<div class="scroll-bar_body">',
                    '<div class="scroll-bar_body-inner"></div>',
                    '</div>',
                    '<div class="scroll-bar_bottom"></div>',
                    '<div class="scroll-bar_center"></div>',
                    '</div>',
                    '</div>',
                    '</div>'
                ].join(''),
                simple: [
                    '<div class="scroll-element">',
                    '<div class="scroll-element_outer">',
                    '<div class="scroll-element_size"></div>', // required! used for scrollbar size calculation !
                    '<div class="scroll-element_track"></div>', // used for handling scrollbar click
                    '<div class="scroll-bar"></div>', // required
                    '</div>',
                    '</div>'
                ].join('')
            };
            if (types[scroll]) {
                scroll = types[scroll];
            }
            if (!scroll) {
                scroll = types['simple'];
            }
            if (typeof (scroll) == 'string') {
                scroll = $(scroll).appendTo(this.wrapper);
            } else {
                scroll = $(scroll);
            }
            $.extend(scroll, {
                bar: scroll.find('.scroll-bar'),
                size: scroll.find('.scroll-element_size'),
                track: scroll.find('.scroll-element_track')
            });
            return scroll;
        },
        _handleMouseDown: function (callback, event) {

            var namespace = this.namespace;

            $(document).on('blur' + namespace, function () {
                $(document).add('body').off(namespace);
                callback && callback();
            });
            $(document).on('dragstart' + namespace, function (event) {
                event.preventDefault();
                return false;
            });
            $(document).on('mouseup' + namespace, function () {
                $(document).add('body').off(namespace);
                callback && callback();
            });
            $('body').on('selectstart' + namespace, function (event) {
                event.preventDefault();
                return false;
            });

            event && event.preventDefault();
            return false;
        },
        _updateScroll: function (d, scrollx) {

            var container = this.container,
                containerWrapper = this.containerWrapper || container,
                scrollClass = 'scroll-scroll' + d + '_visible',
                scrolly = (d === 'x') ? this.scrolly : this.scrollx,
                offset = parseInt(this.container.css((d === 'x') ? 'left' : 'top'), 10) || 0,
                wrapper = this.wrapper;

            var AreaSize = scrollx.size;
            var AreaVisible = scrollx.visible + offset;

            scrollx.isVisible = (AreaSize - AreaVisible) > 1; // bug in IE9/11 with 1px diff
            if (scrollx.isVisible) {
                scrollx.scroll.addClass(scrollClass);
                scrolly.scroll.addClass(scrollClass);
                containerWrapper.addClass(scrollClass);
            } else {
                scrollx.scroll.removeClass(scrollClass);
                scrolly.scroll.removeClass(scrollClass);
                containerWrapper.removeClass(scrollClass);
            }

            if (d === 'y') {
                if (container.is('textarea') || AreaSize < AreaVisible) {
                    containerWrapper.css({
                        "height": (AreaVisible + browser.scroll.height) + 'px',
                        "max-height": "none"
                    });
                } else {
                    containerWrapper.css({
                        //"height": "auto", // do not reset height value: issue with height:100%!
                        "max-height": (AreaVisible + browser.scroll.height) + 'px'
                    });
                }
            }

            if (scrollx.size != container.prop('scrollWidth')
                || scrolly.size != container.prop('scrollHeight')
                || scrollx.visible != wrapper.width()
                || scrolly.visible != wrapper.height()
                || scrollx.offset != (parseInt(container.css('left'), 10) || 0)
                || scrolly.offset != (parseInt(container.css('top'), 10) || 0)
                ) {
                $.extend(this.scrollx, {
                    offset: parseInt(container.css('left'), 10) || 0,
                    size: container.prop('scrollWidth'),
                    visible: wrapper.width()
                });
                $.extend(this.scrolly, {
                    offset: parseInt(container.css('top'), 10) || 0,
                    size: this.container.prop('scrollHeight'),
                    visible: wrapper.height()
                });
                this._updateScroll(d === 'x' ? 'y' : 'x', scrolly);
            }
        }
    };

    var CustomScrollbar = BaseScrollbar;

    /*
     * Extend jQuery as plugin
     *
     * @param {Mixed} command to execute
     * @param {Mixed} arguments as Array
     * @return {jQuery}
     */
    $.fn.scrollbar = function (command, args) {
        if (typeof command !== 'string') {
            args = command;
            command = 'init';
        }
        if (typeof args === 'undefined') {
            args = [];
        }
        if (!$.isArray(args)) {
            args = [args];
        }
        this.not('body, .scroll-wrapper').each(function () {
            var element = $(this),
                instance = element.data(browser.data.name);
            if (instance || command === 'init') {
                if (!instance) {
                    instance = new CustomScrollbar(element);
                }
                if (instance[command]) {
                    instance[command].apply(instance, args);
                }
            }
        });
        return this;
    };

    /**
     * Connect default options to global object
     */
    $.fn.scrollbar.options = defaults;


    /**
     * Check if scroll content/container size is changed
     */

    var updateScrollbars = (function () {
        var timer = 0,
            timerCounter = 0;

        return function (force) {
            var i, container, options, scroll, wrapper, scrollx, scrolly;
            for (i = 0; i < browser.scrolls.length; i++) {
                scroll = browser.scrolls[i];
                container = scroll.container;
                options = scroll.options;
                wrapper = scroll.wrapper;
                scrollx = scroll.scrollx;
                scrolly = scroll.scrolly;
                if (force || (options.autoUpdate && wrapper && wrapper.is(':visible') &&
                    (container.prop('scrollWidth') != scrollx.size || container.prop('scrollHeight') != scrolly.size || wrapper.width() != scrollx.visible || wrapper.height() != scrolly.visible))) {
                    scroll.init();

                    if (options.debug) {
                        window.console && console.log({
                            scrollHeight: container.prop('scrollHeight') + ':' + scroll.scrolly.size,
                            scrollWidth: container.prop('scrollWidth') + ':' + scroll.scrollx.size,
                            visibleHeight: wrapper.height() + ':' + scroll.scrolly.visible,
                            visibleWidth: wrapper.width() + ':' + scroll.scrollx.visible
                        }, true);
                        timerCounter++;
                    }
                }
            }
            if (debug && timerCounter > 10) {
                window.console && console.log('Scroll updates exceed 10');
                updateScrollbars = function () {};
            } else {
                clearTimeout(timer);
                timer = setTimeout(updateScrollbars, 300);
            }
        };
    })();

    /* ADDITIONAL FUNCTIONS */
    /**
     * Get native browser scrollbar size (height/width)
     *
     * @param {Boolean} actual size or CSS size, default - CSS size
     * @returns {Object} with height, width
     */
    function getBrowserScrollSize(actualSize) {

        if (browser.webkit && !actualSize) {
            return {
                height: 0,
                width: 0
            };
        }

        if (!browser.data.outer) {
            var css = {
                "border": "none",
                "box-sizing": "content-box",
                "height": "200px",
                "margin": "0",
                "padding": "0",
                "width": "200px"
            };
            browser.data.inner = $("<div>").css($.extend({}, css));
            browser.data.outer = $("<div>").css($.extend({
                "left": "-1000px",
                "overflow": "scroll",
                "position": "absolute",
                "top": "-1000px"
            }, css)).append(browser.data.inner).appendTo("body");
        }

        browser.data.outer.scrollLeft(1000).scrollTop(1000);

        return {
            height: Math.ceil((browser.data.outer.offset().top - browser.data.inner.offset().top) || 0),
            width: Math.ceil((browser.data.outer.offset().left - browser.data.inner.offset().left) || 0)
        };
    }

    /**
     * Check if native browser scrollbars overlay content
     *
     * @returns {Boolean}
     */
    function isScrollOverlaysContent() {
        var scrollSize = getBrowserScrollSize(true);
        return !(scrollSize.height || scrollSize.width);
    }

    function isVerticalScroll(event) {
        var e = event.originalEvent;
        if (e.axis && e.axis === e.HORIZONTAL_AXIS)
            return false;
        if (e.wheelDeltaX)
            return false;
        return true;
    }


    /**
     * Extend AngularJS as UI directive
     * and expose a provider for override default config
     *
     */
    if (window.angular) {
        (function (angular) {
            angular.module('jQueryScrollbar', [])
                .provider('jQueryScrollbar', function () {
                    var defaultOptions = defaults;
                    return {
                        setOptions: function (options) {
                            angular.extend(defaultOptions, options);
                        },
                        $get: function () {
                            return {
                                options: angular.copy(defaultOptions)
                            };
                        }
                    };
                })
                .directive('jqueryScrollbar', ['jQueryScrollbar', '$parse', function (jQueryScrollbar, $parse) {
                        return {
                            restrict: "AC",
                            link: function (scope, element, attrs) {
                                var model = $parse(attrs.jqueryScrollbar),
                                    options = model(scope);
                                element.scrollbar(options || jQueryScrollbar.options)
                                    .on('$destroy', function () {
                                        element.scrollbar('destroy');
                                    });
                            }
                        };
                    }]);
        })(window.angular);
    }
}));
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJsaWJzL2pxdWVyeS5zY3JvbGxiYXIubWluLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogalF1ZXJ5IENTUyBDdXN0b21pemFibGUgU2Nyb2xsYmFyXG4gKlxuICogQ29weXJpZ2h0IDIwMTUsIFl1cml5IEtoYWJhcm92XG4gKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy5cbiAqXG4gKiBJZiB5b3UgZm91bmQgYnVnLCBwbGVhc2UgY29udGFjdCBtZSB2aWEgZW1haWwgPDEzcmVhbDAwOEBnbWFpbC5jb20+XG4gKlxuICogQGF1dGhvciBZdXJpeSBLaGFiYXJvdiBha2EgR3JvbW9cbiAqIEB2ZXJzaW9uIDAuMi4xMVxuICogQHVybCBodHRwczovL2dpdGh1Yi5jb20vZ3JvbW8vanF1ZXJ5LnNjcm9sbGJhci9cbiAqXG4gKi9cbjtcbihmdW5jdGlvbiAocm9vdCwgZmFjdG9yeSkge1xuICAgIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHtcbiAgICAgICAgZGVmaW5lKFsnanF1ZXJ5J10sIGZhY3RvcnkpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgZmFjdG9yeShyZXF1aXJlKCdqcXVlcnknKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZmFjdG9yeShyb290LmpRdWVyeSk7XG4gICAgfVxufSh0aGlzLCBmdW5jdGlvbiAoJCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIC8vIGluaXQgZmxhZ3MgJiB2YXJpYWJsZXNcbiAgICB2YXIgZGVidWcgPSBmYWxzZTtcblxuICAgIHZhciBicm93c2VyID0ge1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBpbmRleDogMCxcbiAgICAgICAgICAgIG5hbWU6ICdzY3JvbGxiYXInXG4gICAgICAgIH0sXG4gICAgICAgIGZpcmVmb3g6IC9maXJlZm94L2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSxcbiAgICAgICAgbWFjb3N4OiAvbWFjL2kudGVzdChuYXZpZ2F0b3IucGxhdGZvcm0pLFxuICAgICAgICBtc2VkZ2U6IC9lZGdlXFwvXFxkKy9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCksXG4gICAgICAgIG1zaWU6IC8obXNpZXx0cmlkZW50KS9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCksXG4gICAgICAgIG1vYmlsZTogL2FuZHJvaWR8d2Vib3N8aXBob25lfGlwYWR8aXBvZHxibGFja2JlcnJ5L2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSxcbiAgICAgICAgb3ZlcmxheTogbnVsbCxcbiAgICAgICAgc2Nyb2xsOiBudWxsLFxuICAgICAgICBzY3JvbGxzOiBbXSxcbiAgICAgICAgd2Via2l0OiAvd2Via2l0L2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSAmJiAhL2VkZ2VcXC9cXGQrL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KVxuICAgIH07XG5cbiAgICBicm93c2VyLnNjcm9sbHMuYWRkID0gZnVuY3Rpb24gKGluc3RhbmNlKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlKGluc3RhbmNlKS5wdXNoKGluc3RhbmNlKTtcbiAgICB9O1xuICAgIGJyb3dzZXIuc2Nyb2xscy5yZW1vdmUgPSBmdW5jdGlvbiAoaW5zdGFuY2UpIHtcbiAgICAgICAgd2hpbGUgKCQuaW5BcnJheShpbnN0YW5jZSwgdGhpcykgPj0gMCkge1xuICAgICAgICAgICAgdGhpcy5zcGxpY2UoJC5pbkFycmF5KGluc3RhbmNlLCB0aGlzKSwgMSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfTtcblxuICAgIHZhciBkZWZhdWx0cyA9IHtcbiAgICAgICAgYXV0b1Njcm9sbFNpemU6IHRydWUsIC8vIGF1dG9tYXRpY2FsbHkgY2FsY3VsYXRlIHNjcm9sbHNpemVcbiAgICAgICAgYXV0b1VwZGF0ZTogdHJ1ZSwgLy8gdXBkYXRlIHNjcm9sbGJhciBpZiBjb250ZW50L2NvbnRhaW5lciBzaXplIGNoYW5nZWRcbiAgICAgICAgZGVidWc6IGZhbHNlLCAvLyBkZWJ1ZyBtb2RlXG4gICAgICAgIGRpc2FibGVCb2R5U2Nyb2xsOiBmYWxzZSwgLy8gZGlzYWJsZSBib2R5IHNjcm9sbCBpZiBtb3VzZSBvdmVyIGNvbnRhaW5lclxuICAgICAgICBkdXJhdGlvbjogMjAwLCAvLyBzY3JvbGwgYW5pbWF0ZSBkdXJhdGlvbiBpbiBtc1xuICAgICAgICBpZ25vcmVNb2JpbGU6IGZhbHNlLCAvLyBpZ25vcmUgbW9iaWxlIGRldmljZXNcbiAgICAgICAgaWdub3JlT3ZlcmxheTogZmFsc2UsIC8vIGlnbm9yZSBicm93c2VycyB3aXRoIG92ZXJsYXkgc2Nyb2xsYmFycyAobW9iaWxlLCBNYWNPUylcbiAgICAgICAgaXNSdGw6IGZhbHNlLCAvLyBpcyBSVExcbiAgICAgICAgc2Nyb2xsU3RlcDogMzAsIC8vIHNjcm9sbCBzdGVwIGZvciBzY3JvbGxiYXIgYXJyb3dzXG4gICAgICAgIHNob3dBcnJvd3M6IGZhbHNlLCAvLyBhZGQgY2xhc3MgdG8gc2hvdyBhcnJvd3NcbiAgICAgICAgc3RlcFNjcm9sbGluZzogdHJ1ZSwgLy8gd2hlbiBzY3JvbGxpbmcgdG8gc2Nyb2xsYmFyIG1vdXNlZG93biBwb3NpdGlvblxuXG4gICAgICAgIHNjcm9sbHg6IG51bGwsIC8vIGhvcml6b250YWwgc2Nyb2xsIGVsZW1lbnRcbiAgICAgICAgc2Nyb2xseTogbnVsbCwgLy8gdmVydGljYWwgc2Nyb2xsIGVsZW1lbnRcblxuICAgICAgICBvbkRlc3Ryb3k6IG51bGwsIC8vIGNhbGxiYWNrIGZ1bmN0aW9uIG9uIGRlc3Ryb3ksXG4gICAgICAgIG9uRmFsbGJhY2s6IG51bGwsIC8vIGNhbGxiYWNrIGZ1bmN0aW9uIGlmIHNjcm9sbGJhciBpcyBub3QgaW5pdGlhbGl6ZWRcbiAgICAgICAgb25Jbml0OiBudWxsLCAvLyBjYWxsYmFjayBmdW5jdGlvbiBvbiBmaXJzdCBpbml0aWFsaXphdGlvblxuICAgICAgICBvblNjcm9sbDogbnVsbCwgLy8gY2FsbGJhY2sgZnVuY3Rpb24gb24gY29udGVudCBzY3JvbGxpbmdcbiAgICAgICAgb25VcGRhdGU6IG51bGwgICAgICAgICAgICAvLyBjYWxsYmFjayBmdW5jdGlvbiBvbiBpbml0L3Jlc2l6ZSAoYmVmb3JlIHNjcm9sbGJhciBzaXplIGNhbGN1bGF0aW9uKVxuICAgIH07XG5cblxuICAgIHZhciBCYXNlU2Nyb2xsYmFyID0gZnVuY3Rpb24gKGNvbnRhaW5lcikge1xuXG4gICAgICAgIGlmICghYnJvd3Nlci5zY3JvbGwpIHtcbiAgICAgICAgICAgIGJyb3dzZXIub3ZlcmxheSA9IGlzU2Nyb2xsT3ZlcmxheXNDb250ZW50KCk7XG4gICAgICAgICAgICBicm93c2VyLnNjcm9sbCA9IGdldEJyb3dzZXJTY3JvbGxTaXplKCk7XG4gICAgICAgICAgICB1cGRhdGVTY3JvbGxiYXJzKCk7XG5cbiAgICAgICAgICAgICQod2luZG93KS5yZXNpemUoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBmb3JjZVVwZGF0ZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChicm93c2VyLnNjcm9sbCAmJiAoYnJvd3Nlci5zY3JvbGwuaGVpZ2h0IHx8IGJyb3dzZXIuc2Nyb2xsLndpZHRoKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsID0gZ2V0QnJvd3NlclNjcm9sbFNpemUoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNjcm9sbC5oZWlnaHQgIT09IGJyb3dzZXIuc2Nyb2xsLmhlaWdodCB8fCBzY3JvbGwud2lkdGggIT09IGJyb3dzZXIuc2Nyb2xsLndpZHRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicm93c2VyLnNjcm9sbCA9IHNjcm9sbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlVXBkYXRlID0gdHJ1ZTsgLy8gaGFuZGxlIHBhZ2Ugem9vbVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHVwZGF0ZVNjcm9sbGJhcnMoZm9yY2VVcGRhdGUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjtcbiAgICAgICAgdGhpcy5uYW1lc3BhY2UgPSAnLnNjcm9sbGJhcl8nICsgYnJvd3Nlci5kYXRhLmluZGV4Kys7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCBkZWZhdWx0cywgd2luZG93LmpRdWVyeVNjcm9sbGJhck9wdGlvbnMgfHwge30pO1xuICAgICAgICB0aGlzLnNjcm9sbFRvID0gbnVsbDtcbiAgICAgICAgdGhpcy5zY3JvbGx4ID0ge307XG4gICAgICAgIHRoaXMuc2Nyb2xseSA9IHt9O1xuXG4gICAgICAgIGNvbnRhaW5lci5kYXRhKGJyb3dzZXIuZGF0YS5uYW1lLCB0aGlzKTtcbiAgICAgICAgYnJvd3Nlci5zY3JvbGxzLmFkZCh0aGlzKTtcbiAgICB9O1xuXG4gICAgQmFzZVNjcm9sbGJhci5wcm90b3R5cGUgPSB7XG4gICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLndyYXBwZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZURhdGEoYnJvd3Nlci5kYXRhLm5hbWUpO1xuICAgICAgICAgICAgYnJvd3Nlci5zY3JvbGxzLnJlbW92ZSh0aGlzKTtcblxuICAgICAgICAgICAgLy8gaW5pdCB2YXJpYWJsZXNcbiAgICAgICAgICAgIHZhciBzY3JvbGxMZWZ0ID0gdGhpcy5jb250YWluZXIuc2Nyb2xsTGVmdCgpO1xuICAgICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IHRoaXMuY29udGFpbmVyLnNjcm9sbFRvcCgpO1xuXG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5pbnNlcnRCZWZvcmUodGhpcy53cmFwcGVyKS5jc3Moe1xuICAgICAgICAgICAgICAgIFwiaGVpZ2h0XCI6IFwiXCIsXG4gICAgICAgICAgICAgICAgXCJtYXJnaW5cIjogXCJcIixcbiAgICAgICAgICAgICAgICBcIm1heC1oZWlnaHRcIjogXCJcIlxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ3Njcm9sbC1jb250ZW50IHNjcm9sbC1zY3JvbGx4X3Zpc2libGUgc2Nyb2xsLXNjcm9sbHlfdmlzaWJsZScpXG4gICAgICAgICAgICAgICAgLm9mZih0aGlzLm5hbWVzcGFjZSlcbiAgICAgICAgICAgICAgICAuc2Nyb2xsTGVmdChzY3JvbGxMZWZ0KVxuICAgICAgICAgICAgICAgIC5zY3JvbGxUb3Aoc2Nyb2xsVG9wKTtcblxuICAgICAgICAgICAgdGhpcy5zY3JvbGx4LnNjcm9sbC5yZW1vdmVDbGFzcygnc2Nyb2xsLXNjcm9sbHhfdmlzaWJsZScpLmZpbmQoJ2RpdicpLmFkZEJhY2soKS5vZmYodGhpcy5uYW1lc3BhY2UpO1xuICAgICAgICAgICAgdGhpcy5zY3JvbGx5LnNjcm9sbC5yZW1vdmVDbGFzcygnc2Nyb2xsLXNjcm9sbHlfdmlzaWJsZScpLmZpbmQoJ2RpdicpLmFkZEJhY2soKS5vZmYodGhpcy5uYW1lc3BhY2UpO1xuXG4gICAgICAgICAgICB0aGlzLndyYXBwZXIucmVtb3ZlKCk7XG5cbiAgICAgICAgICAgICQoZG9jdW1lbnQpLmFkZCgnYm9keScpLm9mZih0aGlzLm5hbWVzcGFjZSk7XG5cbiAgICAgICAgICAgIGlmICgkLmlzRnVuY3Rpb24odGhpcy5vcHRpb25zLm9uRGVzdHJveSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMub25EZXN0cm95LmFwcGx5KHRoaXMsIFt0aGlzLmNvbnRhaW5lcl0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBpbml0OiBmdW5jdGlvbiAob3B0aW9ucykge1xuXG4gICAgICAgICAgICAvLyBpbml0IHZhcmlhYmxlc1xuICAgICAgICAgICAgdmFyIFMgPSB0aGlzLFxuICAgICAgICAgICAgICAgIGMgPSB0aGlzLmNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBjdyA9IHRoaXMuY29udGFpbmVyV3JhcHBlciB8fCBjLFxuICAgICAgICAgICAgICAgIG5hbWVzcGFjZSA9IHRoaXMubmFtZXNwYWNlLFxuICAgICAgICAgICAgICAgIG8gPSAkLmV4dGVuZCh0aGlzLm9wdGlvbnMsIG9wdGlvbnMgfHwge30pLFxuICAgICAgICAgICAgICAgIHMgPSB7eDogdGhpcy5zY3JvbGx4LCB5OiB0aGlzLnNjcm9sbHl9LFxuICAgICAgICAgICAgdyA9IHRoaXMud3JhcHBlcixcbiAgICAgICAgICAgICAgICBjc3NPcHRpb25zID0ge307XG5cbiAgICAgICAgICAgIHZhciBpbml0U2Nyb2xsID0ge1xuICAgICAgICAgICAgICAgIHNjcm9sbExlZnQ6IGMuc2Nyb2xsTGVmdCgpLFxuICAgICAgICAgICAgICAgIHNjcm9sbFRvcDogYy5zY3JvbGxUb3AoKVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy8gZG8gbm90IGluaXQgaWYgaW4gaWdub3JhYmxlIGJyb3dzZXJcbiAgICAgICAgICAgIGlmICgoYnJvd3Nlci5tb2JpbGUgJiYgby5pZ25vcmVNb2JpbGUpXG4gICAgICAgICAgICAgICAgfHwgKGJyb3dzZXIub3ZlcmxheSAmJiBvLmlnbm9yZU92ZXJsYXkpXG4gICAgICAgICAgICAgICAgfHwgKGJyb3dzZXIubWFjb3N4ICYmICFicm93c2VyLndlYmtpdCkgLy8gc3RpbGwgcmVxdWlyZWQgdG8gaWdub3JlIG5vbldlYktpdCBicm93c2VycyBvbiBNYWNcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKG8ub25GYWxsYmFjaykpIHtcbiAgICAgICAgICAgICAgICAgICAgby5vbkZhbGxiYWNrLmFwcGx5KHRoaXMsIFtjXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gaW5pdCBzY3JvbGwgY29udGFpbmVyXG4gICAgICAgICAgICBpZiAoIXcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLndyYXBwZXIgPSB3ID0gJCgnPGRpdj4nKS5hZGRDbGFzcygnc2Nyb2xsLXdyYXBwZXInKS5hZGRDbGFzcyhjLmF0dHIoJ2NsYXNzJykpXG4gICAgICAgICAgICAgICAgICAgIC5jc3MoJ3Bvc2l0aW9uJywgYy5jc3MoJ3Bvc2l0aW9uJykgPT09ICdhYnNvbHV0ZScgPyAnYWJzb2x1dGUnIDogJ3JlbGF0aXZlJylcbiAgICAgICAgICAgICAgICAgICAgLmluc2VydEJlZm9yZShjKS5hcHBlbmQoYyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoby5pc1J0bCkge1xuICAgICAgICAgICAgICAgICAgICB3LmFkZENsYXNzKCdzY3JvbGwtLXJ0bCcpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjLmlzKCd0ZXh0YXJlYScpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyV3JhcHBlciA9IGN3ID0gJCgnPGRpdj4nKS5pbnNlcnRCZWZvcmUoYykuYXBwZW5kKGMpO1xuICAgICAgICAgICAgICAgICAgICB3LmFkZENsYXNzKCdzY3JvbGwtdGV4dGFyZWEnKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjc3NPcHRpb25zID0ge1xuICAgICAgICAgICAgICAgICAgICBcImhlaWdodFwiOiBcImF1dG9cIixcbiAgICAgICAgICAgICAgICAgICAgXCJtYXJnaW4tYm90dG9tXCI6IGJyb3dzZXIuc2Nyb2xsLmhlaWdodCAqIC0xICsgJ3B4JyxcbiAgICAgICAgICAgICAgICAgICAgXCJtYXgtaGVpZ2h0XCI6IFwiXCJcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGNzc09wdGlvbnNbby5pc1J0bCA/ICdtYXJnaW4tbGVmdCcgOiAnbWFyZ2luLXJpZ2h0J10gPSBicm93c2VyLnNjcm9sbC53aWR0aCAqIC0xICsgJ3B4JztcblxuICAgICAgICAgICAgICAgIGN3LmFkZENsYXNzKCdzY3JvbGwtY29udGVudCcpLmNzcyhjc3NPcHRpb25zKTtcblxuICAgICAgICAgICAgICAgIGMub24oJ3Njcm9sbCcgKyBuYW1lc3BhY2UsIGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsTGVmdCA9IGMuc2Nyb2xsTGVmdCgpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gYy5zY3JvbGxUb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG8uaXNSdGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlYmtpdCAgIDA6MTAwXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBpZS9lZGdlICAxMDA6MFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmlyZWZveCAtMTAwOjBcbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgYnJvd3Nlci5maXJlZm94OlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxMZWZ0ID0gTWF0aC5hYnMoc2Nyb2xsTGVmdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBicm93c2VyLm1zZWRnZSB8fCBicm93c2VyLm1zaWU6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbExlZnQgPSBjWzBdLnNjcm9sbFdpZHRoIC0gY1swXS5jbGllbnRXaWR0aCAtIHNjcm9sbExlZnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICgkLmlzRnVuY3Rpb24oby5vblNjcm9sbCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG8ub25TY3JvbGwuY2FsbChTLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4U2Nyb2xsOiBzLnkubWF4U2Nyb2xsT2Zmc2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbDogc2Nyb2xsVG9wLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpemU6IHMueS5zaXplLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHMueS52aXNpYmxlXG4gICAgICAgICAgICAgICAgICAgICAgICB9LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4U2Nyb2xsOiBzLngubWF4U2Nyb2xsT2Zmc2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbDogc2Nyb2xsTGVmdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplOiBzLnguc2l6ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiBzLngudmlzaWJsZVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcy54LmlzVmlzaWJsZSAmJiBzLnguc2Nyb2xsLmJhci5jc3MoJ2xlZnQnLCBzY3JvbGxMZWZ0ICogcy54Lmt4ICsgJ3B4Jyk7XG4gICAgICAgICAgICAgICAgICAgIHMueS5pc1Zpc2libGUgJiYgcy55LnNjcm9sbC5iYXIuY3NzKCd0b3AnLCBzY3JvbGxUb3AgKiBzLnkua3ggKyAncHgnKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIC8qIHByZXZlbnQgbmF0aXZlIHNjcm9sbGJhcnMgdG8gYmUgdmlzaWJsZSBvbiAjYW5jaG9yIGNsaWNrICovXG4gICAgICAgICAgICAgICAgdy5vbignc2Nyb2xsJyArIG5hbWVzcGFjZSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB3LnNjcm9sbFRvcCgwKS5zY3JvbGxMZWZ0KDApO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgaWYgKG8uZGlzYWJsZUJvZHlTY3JvbGwpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGhhbmRsZU1vdXNlU2Nyb2xsID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpc1ZlcnRpY2FsU2Nyb2xsKGV2ZW50KSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy55LmlzVmlzaWJsZSAmJiBzLnkubW91c2V3aGVlbChldmVudCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMueC5pc1Zpc2libGUgJiYgcy54Lm1vdXNld2hlZWwoZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB3Lm9uKCdNb3pNb3VzZVBpeGVsU2Nyb2xsJyArIG5hbWVzcGFjZSwgaGFuZGxlTW91c2VTY3JvbGwpO1xuICAgICAgICAgICAgICAgICAgICB3Lm9uKCdtb3VzZXdoZWVsJyArIG5hbWVzcGFjZSwgaGFuZGxlTW91c2VTY3JvbGwpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChicm93c2VyLm1vYmlsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdy5vbigndG91Y2hzdGFydCcgKyBuYW1lc3BhY2UsIGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b3VjaCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyAmJiBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbMF0gfHwgZXZlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsVG91Y2ggPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VYOiB0b3VjaC5wYWdlWCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZVk6IHRvdWNoLnBhZ2VZXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxTY3JvbGwgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IGMuc2Nyb2xsTGVmdCgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IGMuc2Nyb2xsVG9wKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCd0b3VjaG1vdmUnICsgbmFtZXNwYWNlLCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRvdWNoID0gZXZlbnQub3JpZ2luYWxFdmVudC50YXJnZXRUb3VjaGVzICYmIGV2ZW50Lm9yaWdpbmFsRXZlbnQudGFyZ2V0VG91Y2hlc1swXSB8fCBldmVudDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYy5zY3JvbGxMZWZ0KG9yaWdpbmFsU2Nyb2xsLmxlZnQgKyBvcmlnaW5hbFRvdWNoLnBhZ2VYIC0gdG91Y2gucGFnZVgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjLnNjcm9sbFRvcChvcmlnaW5hbFNjcm9sbC50b3AgKyBvcmlnaW5hbFRvdWNoLnBhZ2VZIC0gdG91Y2gucGFnZVkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCd0b3VjaGVuZCcgKyBuYW1lc3BhY2UsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChkb2N1bWVudCkub2ZmKG5hbWVzcGFjZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoJC5pc0Z1bmN0aW9uKG8ub25Jbml0KSkge1xuICAgICAgICAgICAgICAgICAgICBvLm9uSW5pdC5hcHBseSh0aGlzLCBbY10pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY3NzT3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICAgICAgXCJoZWlnaHRcIjogXCJhdXRvXCIsXG4gICAgICAgICAgICAgICAgICAgIFwibWFyZ2luLWJvdHRvbVwiOiBicm93c2VyLnNjcm9sbC5oZWlnaHQgKiAtMSArICdweCcsXG4gICAgICAgICAgICAgICAgICAgIFwibWF4LWhlaWdodFwiOiBcIlwiXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBjc3NPcHRpb25zW28uaXNSdGwgPyAnbWFyZ2luLWxlZnQnIDogJ21hcmdpbi1yaWdodCddID0gYnJvd3Nlci5zY3JvbGwud2lkdGggKiAtMSArICdweCc7XG4gICAgICAgICAgICAgICAgY3cuY3NzKGNzc09wdGlvbnMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBpbml0IHNjcm9sbGJhcnMgJiByZWNhbGN1bGF0ZSBzaXplc1xuICAgICAgICAgICAgJC5lYWNoKHMsIGZ1bmN0aW9uIChkLCBzY3JvbGx4KSB7XG5cbiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsQ2FsbGJhY2sgPSBudWxsO1xuICAgICAgICAgICAgICAgIHZhciBzY3JvbGxGb3J3YXJkID0gMTtcbiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsT2Zmc2V0ID0gKGQgPT09ICd4JykgPyAnc2Nyb2xsTGVmdCcgOiAnc2Nyb2xsVG9wJztcbiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsU3RlcCA9IG8uc2Nyb2xsU3RlcDtcbiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsVG8gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50T2Zmc2V0ID0gY1tzY3JvbGxPZmZzZXRdKCk7XG4gICAgICAgICAgICAgICAgICAgIGNbc2Nyb2xsT2Zmc2V0XShjdXJyZW50T2Zmc2V0ICsgc2Nyb2xsU3RlcCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzY3JvbGxGb3J3YXJkID09IDEgJiYgKGN1cnJlbnRPZmZzZXQgKyBzY3JvbGxTdGVwKSA+PSBzY3JvbGxUb1ZhbHVlKVxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE9mZnNldCA9IGNbc2Nyb2xsT2Zmc2V0XSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsRm9yd2FyZCA9PSAtMSAmJiAoY3VycmVudE9mZnNldCArIHNjcm9sbFN0ZXApIDw9IHNjcm9sbFRvVmFsdWUpXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50T2Zmc2V0ID0gY1tzY3JvbGxPZmZzZXRdKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjW3Njcm9sbE9mZnNldF0oKSA9PSBjdXJyZW50T2Zmc2V0ICYmIHNjcm9sbENhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxDYWxsYmFjaygpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBzY3JvbGxUb1ZhbHVlID0gMDtcblxuICAgICAgICAgICAgICAgIGlmICghc2Nyb2xseC5zY3JvbGwpIHtcblxuICAgICAgICAgICAgICAgICAgICBzY3JvbGx4LnNjcm9sbCA9IFMuX2dldFNjcm9sbChvWydzY3JvbGwnICsgZF0pLmFkZENsYXNzKCdzY3JvbGwtJyArIGQpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChvLnNob3dBcnJvd3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbHguc2Nyb2xsLmFkZENsYXNzKCdzY3JvbGwtZWxlbWVudF9hcnJvd3NfdmlzaWJsZScpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgc2Nyb2xseC5tb3VzZXdoZWVsID0gZnVuY3Rpb24gKGV2ZW50KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc2Nyb2xseC5pc1Zpc2libGUgfHwgKGQgPT09ICd4JyAmJiBpc1ZlcnRpY2FsU2Nyb2xsKGV2ZW50KSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkID09PSAneScgJiYgIWlzVmVydGljYWxTY3JvbGwoZXZlbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy54Lm1vdXNld2hlZWwoZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGVsdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LndoZWVsRGVsdGEgKiAtMSB8fCBldmVudC5vcmlnaW5hbEV2ZW50LmRldGFpbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXhTY3JvbGxWYWx1ZSA9IHNjcm9sbHguc2l6ZSAtIHNjcm9sbHgudmlzaWJsZSAtIHNjcm9sbHgub2Zmc2V0O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBmaXggbmV3IG1vemlsbGFcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGVsdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZCA9PT0gJ3gnICYmICEhZXZlbnQub3JpZ2luYWxFdmVudC5kZWx0YVgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LmRlbHRhWCAqIDQwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZCA9PT0gJ3knICYmICEhZXZlbnQub3JpZ2luYWxFdmVudC5kZWx0YVkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LmRlbHRhWSAqIDQwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChkZWx0YSA+IDAgJiYgc2Nyb2xsVG9WYWx1ZSA8IG1heFNjcm9sbFZhbHVlKSB8fCAoZGVsdGEgPCAwICYmIHNjcm9sbFRvVmFsdWUgPiAwKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvVmFsdWUgPSBzY3JvbGxUb1ZhbHVlICsgZGVsdGE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcm9sbFRvVmFsdWUgPCAwKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxUb1ZhbHVlID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsVG9WYWx1ZSA+IG1heFNjcm9sbFZhbHVlKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxUb1ZhbHVlID0gbWF4U2Nyb2xsVmFsdWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTLnNjcm9sbFRvID0gUy5zY3JvbGxUbyB8fCB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBTLnNjcm9sbFRvW3Njcm9sbE9mZnNldF0gPSBzY3JvbGxUb1ZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoUy5zY3JvbGxUbykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYy5zdG9wKCkuYW5pbWF0ZShTLnNjcm9sbFRvLCAyNDAsICdsaW5lYXInLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9WYWx1ZSA9IGNbc2Nyb2xsT2Zmc2V0XSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTLnNjcm9sbFRvID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIHNjcm9sbHguc2Nyb2xsXG4gICAgICAgICAgICAgICAgICAgICAgICAub24oJ01vek1vdXNlUGl4ZWxTY3JvbGwnICsgbmFtZXNwYWNlLCBzY3JvbGx4Lm1vdXNld2hlZWwpXG4gICAgICAgICAgICAgICAgICAgICAgICAub24oJ21vdXNld2hlZWwnICsgbmFtZXNwYWNlLCBzY3JvbGx4Lm1vdXNld2hlZWwpXG4gICAgICAgICAgICAgICAgICAgICAgICAub24oJ21vdXNlZW50ZXInICsgbmFtZXNwYWNlLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9WYWx1ZSA9IGNbc2Nyb2xsT2Zmc2V0XSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gaGFuZGxlIGFycm93cyAmIHNjcm9sbCBpbm5lciBtb3VzZWRvd24gZXZlbnRcbiAgICAgICAgICAgICAgICAgICAgc2Nyb2xseC5zY3JvbGwuZmluZCgnLnNjcm9sbC1hcnJvdywgLnNjcm9sbC1lbGVtZW50X3RyYWNrJylcbiAgICAgICAgICAgICAgICAgICAgICAgIC5vbignbW91c2Vkb3duJyArIG5hbWVzcGFjZSwgZnVuY3Rpb24gKGV2ZW50KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQud2hpY2ggIT0gMSkgLy8gbG1iXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsRm9yd2FyZCA9IDE7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRPZmZzZXQ6IGV2ZW50WyhkID09PSAneCcpID8gJ3BhZ2VYJyA6ICdwYWdlWSddLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhTY3JvbGxWYWx1ZTogc2Nyb2xseC5zaXplIC0gc2Nyb2xseC52aXNpYmxlIC0gc2Nyb2xseC5vZmZzZXQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbGJhck9mZnNldDogc2Nyb2xseC5zY3JvbGwuYmFyLm9mZnNldCgpWyhkID09PSAneCcpID8gJ2xlZnQnIDogJ3RvcCddLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxiYXJTaXplOiBzY3JvbGx4LnNjcm9sbC5iYXJbKGQgPT09ICd4JykgPyAnb3V0ZXJXaWR0aCcgOiAnb3V0ZXJIZWlnaHQnXSgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGltZW91dCA9IDAsIHRpbWVyID0gMDtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCdzY3JvbGwtYXJyb3cnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxGb3J3YXJkID0gJCh0aGlzKS5oYXNDbGFzcyhcInNjcm9sbC1hcnJvd19tb3JlXCIpID8gMSA6IC0xO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxTdGVwID0gby5zY3JvbGxTdGVwICogc2Nyb2xsRm9yd2FyZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9WYWx1ZSA9IHNjcm9sbEZvcndhcmQgPiAwID8gZGF0YS5tYXhTY3JvbGxWYWx1ZSA6IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvLmlzUnRsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2godHJ1ZSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBicm93c2VyLmZpcmVmb3g6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvVmFsdWUgPSBzY3JvbGxGb3J3YXJkID4gMCA/IDA6IGRhdGEubWF4U2Nyb2xsVmFsdWUgKiAtMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBicm93c2VyLm1zaWUgfHwgYnJvd3Nlci5tc2VkZ2U6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsRm9yd2FyZCA9IChkYXRhLmV2ZW50T2Zmc2V0ID4gKGRhdGEuc2Nyb2xsYmFyT2Zmc2V0ICsgZGF0YS5zY3JvbGxiYXJTaXplKSA/IDFcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKGRhdGEuZXZlbnRPZmZzZXQgPCBkYXRhLnNjcm9sbGJhck9mZnNldCA/IC0xIDogMCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkID09PSAneCcgJiYgby5pc1J0bCAmJiAoYnJvd3Nlci5tc2llIHx8IGJyb3dzZXIubXNlZGdlKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbEZvcndhcmQgPSBzY3JvbGxGb3J3YXJkICogLTE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFN0ZXAgPSBNYXRoLnJvdW5kKHNjcm9sbHgudmlzaWJsZSAqIDAuNzUpICogc2Nyb2xsRm9yd2FyZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9WYWx1ZSA9IChkYXRhLmV2ZW50T2Zmc2V0IC0gZGF0YS5zY3JvbGxiYXJPZmZzZXQgLVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG8uc3RlcFNjcm9sbGluZyA/IChzY3JvbGxGb3J3YXJkID09IDEgPyBkYXRhLnNjcm9sbGJhclNpemUgOiAwKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogTWF0aC5yb3VuZChkYXRhLnNjcm9sbGJhclNpemUgLyAyKSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxUb1ZhbHVlID0gY1tzY3JvbGxPZmZzZXRdKCkgKyAoc2Nyb2xsVG9WYWx1ZSAvIHNjcm9sbHgua3gpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFMuc2Nyb2xsVG8gPSBTLnNjcm9sbFRvIHx8IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFMuc2Nyb2xsVG9bc2Nyb2xsT2Zmc2V0XSA9IG8uc3RlcFNjcm9sbGluZyA/IGNbc2Nyb2xsT2Zmc2V0XSgpICsgc2Nyb2xsU3RlcCA6IHNjcm9sbFRvVmFsdWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoby5zdGVwU2Nyb2xsaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbENhbGxiYWNrID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9WYWx1ZSA9IGNbc2Nyb2xsT2Zmc2V0XSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVyID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXIgPSBzZXRJbnRlcnZhbChzY3JvbGxUbywgNDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBvLmR1cmF0aW9uICsgMTAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFMuc2Nyb2xsVG8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMuYW5pbWF0ZShTLnNjcm9sbFRvLCBvLmR1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFMuc2Nyb2xsVG8gPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUy5faGFuZGxlTW91c2VEb3duKHNjcm9sbENhbGxiYWNrLCBldmVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBoYW5kbGUgc2Nyb2xsYmFyIGRyYWcnbidkcm9wXG4gICAgICAgICAgICAgICAgICAgIHNjcm9sbHguc2Nyb2xsLmJhci5vbignbW91c2Vkb3duJyArIG5hbWVzcGFjZSwgZnVuY3Rpb24gKGV2ZW50KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC53aGljaCAhPSAxKSAvLyBsbWJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50UG9zaXRpb24gPSBldmVudFsoZCA9PT0gJ3gnKSA/ICdwYWdlWCcgOiAncGFnZVknXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbml0T2Zmc2V0ID0gY1tzY3JvbGxPZmZzZXRdKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbHguc2Nyb2xsLmFkZENsYXNzKCdzY3JvbGwtZHJhZ2dhYmxlJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdtb3VzZW1vdmUnICsgbmFtZXNwYWNlLCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlmZiA9IHBhcnNlSW50KChldmVudFsoZCA9PT0gJ3gnKSA/ICdwYWdlWCcgOiAncGFnZVknXSAtIGV2ZW50UG9zaXRpb24pIC8gc2Nyb2xseC5reCwgMTApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkID09PSAneCcgJiYgby5pc1J0bCAmJiAoYnJvd3Nlci5tc2llIHx8IGJyb3dzZXIubXNlZGdlKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZiA9IGRpZmYgKiAtMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjW3Njcm9sbE9mZnNldF0oaW5pdE9mZnNldCArIGRpZmYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBTLl9oYW5kbGVNb3VzZURvd24oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbHguc2Nyb2xsLnJlbW92ZUNsYXNzKCdzY3JvbGwtZHJhZ2dhYmxlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9WYWx1ZSA9IGNbc2Nyb2xsT2Zmc2V0XSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSwgZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgLy8gcmVtb3ZlIGNsYXNzZXMgJiByZXNldCBhcHBsaWVkIHN0eWxlc1xuICAgICAgICAgICAgJC5lYWNoKHMsIGZ1bmN0aW9uIChkLCBzY3JvbGx4KSB7XG4gICAgICAgICAgICAgICAgdmFyIHNjcm9sbENsYXNzID0gJ3Njcm9sbC1zY3JvbGwnICsgZCArICdfdmlzaWJsZSc7XG4gICAgICAgICAgICAgICAgdmFyIHNjcm9sbHkgPSAoZCA9PSBcInhcIikgPyBzLnkgOiBzLng7XG5cbiAgICAgICAgICAgICAgICBzY3JvbGx4LnNjcm9sbC5yZW1vdmVDbGFzcyhzY3JvbGxDbGFzcyk7XG4gICAgICAgICAgICAgICAgc2Nyb2xseS5zY3JvbGwucmVtb3ZlQ2xhc3Moc2Nyb2xsQ2xhc3MpO1xuICAgICAgICAgICAgICAgIGN3LnJlbW92ZUNsYXNzKHNjcm9sbENsYXNzKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBjYWxjdWxhdGUgaW5pdCBzaXplc1xuICAgICAgICAgICAgJC5lYWNoKHMsIGZ1bmN0aW9uIChkLCBzY3JvbGx4KSB7XG4gICAgICAgICAgICAgICAgJC5leHRlbmQoc2Nyb2xseCwgKGQgPT0gXCJ4XCIpID8ge1xuICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IHBhcnNlSW50KGMuY3NzKCdsZWZ0JyksIDEwKSB8fCAwLFxuICAgICAgICAgICAgICAgICAgICBzaXplOiBjLnByb3AoJ3Njcm9sbFdpZHRoJyksXG4gICAgICAgICAgICAgICAgICAgIHZpc2libGU6IHcud2lkdGgoKVxuICAgICAgICAgICAgICAgIH0gOiB7XG4gICAgICAgICAgICAgICAgICAgIG9mZnNldDogcGFyc2VJbnQoYy5jc3MoJ3RvcCcpLCAxMCkgfHwgMCxcbiAgICAgICAgICAgICAgICAgICAgc2l6ZTogYy5wcm9wKCdzY3JvbGxIZWlnaHQnKSxcbiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogdy5oZWlnaHQoKVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8vIHVwZGF0ZSBzY3JvbGxiYXIgdmlzaWJpbGl0eS9kaW1lbnNpb25zXG4gICAgICAgICAgICB0aGlzLl91cGRhdGVTY3JvbGwoJ3gnLCB0aGlzLnNjcm9sbHgpO1xuICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2Nyb2xsKCd5JywgdGhpcy5zY3JvbGx5KTtcblxuICAgICAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihvLm9uVXBkYXRlKSkge1xuICAgICAgICAgICAgICAgIG8ub25VcGRhdGUuYXBwbHkodGhpcywgW2NdKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gY2FsY3VsYXRlIHNjcm9sbCBzaXplXG4gICAgICAgICAgICAkLmVhY2gocywgZnVuY3Rpb24gKGQsIHNjcm9sbHgpIHtcblxuICAgICAgICAgICAgICAgIHZhciBjc3NPZmZzZXQgPSAoZCA9PT0gJ3gnKSA/ICdsZWZ0JyA6ICd0b3AnO1xuICAgICAgICAgICAgICAgIHZhciBjc3NGdWxsU2l6ZSA9IChkID09PSAneCcpID8gJ291dGVyV2lkdGgnIDogJ291dGVySGVpZ2h0JztcbiAgICAgICAgICAgICAgICB2YXIgY3NzU2l6ZSA9IChkID09PSAneCcpID8gJ3dpZHRoJyA6ICdoZWlnaHQnO1xuICAgICAgICAgICAgICAgIHZhciBvZmZzZXQgPSBwYXJzZUludChjLmNzcyhjc3NPZmZzZXQpLCAxMCkgfHwgMDtcblxuICAgICAgICAgICAgICAgIHZhciBBcmVhU2l6ZSA9IHNjcm9sbHguc2l6ZTtcbiAgICAgICAgICAgICAgICB2YXIgQXJlYVZpc2libGUgPSBzY3JvbGx4LnZpc2libGUgKyBvZmZzZXQ7XG5cbiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsU2l6ZSA9IHNjcm9sbHguc2Nyb2xsLnNpemVbY3NzRnVsbFNpemVdKCkgKyAocGFyc2VJbnQoc2Nyb2xseC5zY3JvbGwuc2l6ZS5jc3MoY3NzT2Zmc2V0KSwgMTApIHx8IDApO1xuXG4gICAgICAgICAgICAgICAgaWYgKG8uYXV0b1Njcm9sbFNpemUpIHtcbiAgICAgICAgICAgICAgICAgICAgc2Nyb2xseC5zY3JvbGxiYXJTaXplID0gcGFyc2VJbnQoc2Nyb2xsU2l6ZSAqIEFyZWFWaXNpYmxlIC8gQXJlYVNpemUsIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgc2Nyb2xseC5zY3JvbGwuYmFyLmNzcyhjc3NTaXplLCBzY3JvbGx4LnNjcm9sbGJhclNpemUgKyAncHgnKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzY3JvbGx4LnNjcm9sbGJhclNpemUgPSBzY3JvbGx4LnNjcm9sbC5iYXJbY3NzRnVsbFNpemVdKCk7XG4gICAgICAgICAgICAgICAgc2Nyb2xseC5reCA9ICgoc2Nyb2xsU2l6ZSAtIHNjcm9sbHguc2Nyb2xsYmFyU2l6ZSkgLyAoQXJlYVNpemUgLSBBcmVhVmlzaWJsZSkpIHx8IDE7XG4gICAgICAgICAgICAgICAgc2Nyb2xseC5tYXhTY3JvbGxPZmZzZXQgPSBBcmVhU2l6ZSAtIEFyZWFWaXNpYmxlO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGMuc2Nyb2xsTGVmdChpbml0U2Nyb2xsLnNjcm9sbExlZnQpLnNjcm9sbFRvcChpbml0U2Nyb2xsLnNjcm9sbFRvcCkudHJpZ2dlcignc2Nyb2xsJyk7XG4gICAgICAgIH0sXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBHZXQgc2Nyb2xseC9zY3JvbGx5IG9iamVjdFxuICAgICAgICAgKlxuICAgICAgICAgKiBAcGFyYW0ge01peGVkfSBzY3JvbGxcbiAgICAgICAgICogQHJldHVybnMge2pRdWVyeX0gc2Nyb2xsIG9iamVjdFxuICAgICAgICAgKi9cbiAgICAgICAgX2dldFNjcm9sbDogZnVuY3Rpb24gKHNjcm9sbCkge1xuICAgICAgICAgICAgdmFyIHR5cGVzID0ge1xuICAgICAgICAgICAgICAgIGFkdmFuY2VkOiBbXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwic2Nyb2xsLWVsZW1lbnRcIj4nLFxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInNjcm9sbC1lbGVtZW50X2Nvcm5lclwiPjwvZGl2PicsXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwic2Nyb2xsLWFycm93IHNjcm9sbC1hcnJvd19sZXNzXCI+PC9kaXY+JyxcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzY3JvbGwtYXJyb3cgc2Nyb2xsLWFycm93X21vcmVcIj48L2Rpdj4nLFxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInNjcm9sbC1lbGVtZW50X291dGVyXCI+JyxcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzY3JvbGwtZWxlbWVudF9zaXplXCI+PC9kaXY+JywgLy8gcmVxdWlyZWQhIHVzZWQgZm9yIHNjcm9sbGJhciBzaXplIGNhbGN1bGF0aW9uICFcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzY3JvbGwtZWxlbWVudF9pbm5lci13cmFwcGVyXCI+JyxcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzY3JvbGwtZWxlbWVudF9pbm5lciBzY3JvbGwtZWxlbWVudF90cmFja1wiPicsIC8vIHVzZWQgZm9yIGhhbmRsaW5nIHNjcm9sbGJhciBjbGlja1xuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInNjcm9sbC1lbGVtZW50X2lubmVyLWJvdHRvbVwiPjwvZGl2PicsXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nLFxuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyxcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzY3JvbGwtYmFyXCI+JywgLy8gcmVxdWlyZWRcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzY3JvbGwtYmFyX2JvZHlcIj4nLFxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInNjcm9sbC1iYXJfYm9keS1pbm5lclwiPjwvZGl2PicsXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nLFxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInNjcm9sbC1iYXJfYm90dG9tXCI+PC9kaXY+JyxcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzY3JvbGwtYmFyX2NlbnRlclwiPjwvZGl2PicsXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nLFxuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyxcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PidcbiAgICAgICAgICAgICAgICBdLmpvaW4oJycpLFxuICAgICAgICAgICAgICAgIHNpbXBsZTogW1xuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInNjcm9sbC1lbGVtZW50XCI+JyxcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzY3JvbGwtZWxlbWVudF9vdXRlclwiPicsXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwic2Nyb2xsLWVsZW1lbnRfc2l6ZVwiPjwvZGl2PicsIC8vIHJlcXVpcmVkISB1c2VkIGZvciBzY3JvbGxiYXIgc2l6ZSBjYWxjdWxhdGlvbiAhXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwic2Nyb2xsLWVsZW1lbnRfdHJhY2tcIj48L2Rpdj4nLCAvLyB1c2VkIGZvciBoYW5kbGluZyBzY3JvbGxiYXIgY2xpY2tcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzY3JvbGwtYmFyXCI+PC9kaXY+JywgLy8gcmVxdWlyZWRcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicsXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgICAgICAgICAgXS5qb2luKCcnKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGlmICh0eXBlc1tzY3JvbGxdKSB7XG4gICAgICAgICAgICAgICAgc2Nyb2xsID0gdHlwZXNbc2Nyb2xsXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghc2Nyb2xsKSB7XG4gICAgICAgICAgICAgICAgc2Nyb2xsID0gdHlwZXNbJ3NpbXBsZSddO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHR5cGVvZiAoc2Nyb2xsKSA9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHNjcm9sbCA9ICQoc2Nyb2xsKS5hcHBlbmRUbyh0aGlzLndyYXBwZXIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzY3JvbGwgPSAkKHNjcm9sbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAkLmV4dGVuZChzY3JvbGwsIHtcbiAgICAgICAgICAgICAgICBiYXI6IHNjcm9sbC5maW5kKCcuc2Nyb2xsLWJhcicpLFxuICAgICAgICAgICAgICAgIHNpemU6IHNjcm9sbC5maW5kKCcuc2Nyb2xsLWVsZW1lbnRfc2l6ZScpLFxuICAgICAgICAgICAgICAgIHRyYWNrOiBzY3JvbGwuZmluZCgnLnNjcm9sbC1lbGVtZW50X3RyYWNrJylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHNjcm9sbDtcbiAgICAgICAgfSxcbiAgICAgICAgX2hhbmRsZU1vdXNlRG93bjogZnVuY3Rpb24gKGNhbGxiYWNrLCBldmVudCkge1xuXG4gICAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5uYW1lc3BhY2U7XG5cbiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdibHVyJyArIG5hbWVzcGFjZSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLmFkZCgnYm9keScpLm9mZihuYW1lc3BhY2UpO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdkcmFnc3RhcnQnICsgbmFtZXNwYWNlLCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgJChkb2N1bWVudCkub24oJ21vdXNldXAnICsgbmFtZXNwYWNlLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgJChkb2N1bWVudCkuYWRkKCdib2R5Jykub2ZmKG5hbWVzcGFjZSk7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgJCgnYm9keScpLm9uKCdzZWxlY3RzdGFydCcgKyBuYW1lc3BhY2UsIGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGV2ZW50ICYmIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0sXG4gICAgICAgIF91cGRhdGVTY3JvbGw6IGZ1bmN0aW9uIChkLCBzY3JvbGx4KSB7XG5cbiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLmNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBjb250YWluZXJXcmFwcGVyID0gdGhpcy5jb250YWluZXJXcmFwcGVyIHx8IGNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBzY3JvbGxDbGFzcyA9ICdzY3JvbGwtc2Nyb2xsJyArIGQgKyAnX3Zpc2libGUnLFxuICAgICAgICAgICAgICAgIHNjcm9sbHkgPSAoZCA9PT0gJ3gnKSA/IHRoaXMuc2Nyb2xseSA6IHRoaXMuc2Nyb2xseCxcbiAgICAgICAgICAgICAgICBvZmZzZXQgPSBwYXJzZUludCh0aGlzLmNvbnRhaW5lci5jc3MoKGQgPT09ICd4JykgPyAnbGVmdCcgOiAndG9wJyksIDEwKSB8fCAwLFxuICAgICAgICAgICAgICAgIHdyYXBwZXIgPSB0aGlzLndyYXBwZXI7XG5cbiAgICAgICAgICAgIHZhciBBcmVhU2l6ZSA9IHNjcm9sbHguc2l6ZTtcbiAgICAgICAgICAgIHZhciBBcmVhVmlzaWJsZSA9IHNjcm9sbHgudmlzaWJsZSArIG9mZnNldDtcblxuICAgICAgICAgICAgc2Nyb2xseC5pc1Zpc2libGUgPSAoQXJlYVNpemUgLSBBcmVhVmlzaWJsZSkgPiAxOyAvLyBidWcgaW4gSUU5LzExIHdpdGggMXB4IGRpZmZcbiAgICAgICAgICAgIGlmIChzY3JvbGx4LmlzVmlzaWJsZSkge1xuICAgICAgICAgICAgICAgIHNjcm9sbHguc2Nyb2xsLmFkZENsYXNzKHNjcm9sbENsYXNzKTtcbiAgICAgICAgICAgICAgICBzY3JvbGx5LnNjcm9sbC5hZGRDbGFzcyhzY3JvbGxDbGFzcyk7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyV3JhcHBlci5hZGRDbGFzcyhzY3JvbGxDbGFzcyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHNjcm9sbHguc2Nyb2xsLnJlbW92ZUNsYXNzKHNjcm9sbENsYXNzKTtcbiAgICAgICAgICAgICAgICBzY3JvbGx5LnNjcm9sbC5yZW1vdmVDbGFzcyhzY3JvbGxDbGFzcyk7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyV3JhcHBlci5yZW1vdmVDbGFzcyhzY3JvbGxDbGFzcyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChkID09PSAneScpIHtcbiAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVyLmlzKCd0ZXh0YXJlYScpIHx8IEFyZWFTaXplIDwgQXJlYVZpc2libGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyV3JhcHBlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJoZWlnaHRcIjogKEFyZWFWaXNpYmxlICsgYnJvd3Nlci5zY3JvbGwuaGVpZ2h0KSArICdweCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIm1heC1oZWlnaHRcIjogXCJub25lXCJcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyV3JhcHBlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgLy9cImhlaWdodFwiOiBcImF1dG9cIiwgLy8gZG8gbm90IHJlc2V0IGhlaWdodCB2YWx1ZTogaXNzdWUgd2l0aCBoZWlnaHQ6MTAwJSFcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibWF4LWhlaWdodFwiOiAoQXJlYVZpc2libGUgKyBicm93c2VyLnNjcm9sbC5oZWlnaHQpICsgJ3B4J1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChzY3JvbGx4LnNpemUgIT0gY29udGFpbmVyLnByb3AoJ3Njcm9sbFdpZHRoJylcbiAgICAgICAgICAgICAgICB8fCBzY3JvbGx5LnNpemUgIT0gY29udGFpbmVyLnByb3AoJ3Njcm9sbEhlaWdodCcpXG4gICAgICAgICAgICAgICAgfHwgc2Nyb2xseC52aXNpYmxlICE9IHdyYXBwZXIud2lkdGgoKVxuICAgICAgICAgICAgICAgIHx8IHNjcm9sbHkudmlzaWJsZSAhPSB3cmFwcGVyLmhlaWdodCgpXG4gICAgICAgICAgICAgICAgfHwgc2Nyb2xseC5vZmZzZXQgIT0gKHBhcnNlSW50KGNvbnRhaW5lci5jc3MoJ2xlZnQnKSwgMTApIHx8IDApXG4gICAgICAgICAgICAgICAgfHwgc2Nyb2xseS5vZmZzZXQgIT0gKHBhcnNlSW50KGNvbnRhaW5lci5jc3MoJ3RvcCcpLCAxMCkgfHwgMClcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAkLmV4dGVuZCh0aGlzLnNjcm9sbHgsIHtcbiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0OiBwYXJzZUludChjb250YWluZXIuY3NzKCdsZWZ0JyksIDEwKSB8fCAwLFxuICAgICAgICAgICAgICAgICAgICBzaXplOiBjb250YWluZXIucHJvcCgnc2Nyb2xsV2lkdGgnKSxcbiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd3JhcHBlci53aWR0aCgpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgJC5leHRlbmQodGhpcy5zY3JvbGx5LCB7XG4gICAgICAgICAgICAgICAgICAgIG9mZnNldDogcGFyc2VJbnQoY29udGFpbmVyLmNzcygndG9wJyksIDEwKSB8fCAwLFxuICAgICAgICAgICAgICAgICAgICBzaXplOiB0aGlzLmNvbnRhaW5lci5wcm9wKCdzY3JvbGxIZWlnaHQnKSxcbiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogd3JhcHBlci5oZWlnaHQoKVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNjcm9sbChkID09PSAneCcgPyAneScgOiAneCcsIHNjcm9sbHkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIHZhciBDdXN0b21TY3JvbGxiYXIgPSBCYXNlU2Nyb2xsYmFyO1xuXG4gICAgLypcbiAgICAgKiBFeHRlbmQgalF1ZXJ5IGFzIHBsdWdpblxuICAgICAqXG4gICAgICogQHBhcmFtIHtNaXhlZH0gY29tbWFuZCB0byBleGVjdXRlXG4gICAgICogQHBhcmFtIHtNaXhlZH0gYXJndW1lbnRzIGFzIEFycmF5XG4gICAgICogQHJldHVybiB7alF1ZXJ5fVxuICAgICAqL1xuICAgICQuZm4uc2Nyb2xsYmFyID0gZnVuY3Rpb24gKGNvbW1hbmQsIGFyZ3MpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBjb21tYW5kICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgYXJncyA9IGNvbW1hbmQ7XG4gICAgICAgICAgICBjb21tYW5kID0gJ2luaXQnO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgYXJncyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGFyZ3MgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoISQuaXNBcnJheShhcmdzKSkge1xuICAgICAgICAgICAgYXJncyA9IFthcmdzXTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5vdCgnYm9keSwgLnNjcm9sbC13cmFwcGVyJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgZWxlbWVudCA9ICQodGhpcyksXG4gICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBlbGVtZW50LmRhdGEoYnJvd3Nlci5kYXRhLm5hbWUpO1xuICAgICAgICAgICAgaWYgKGluc3RhbmNlIHx8IGNvbW1hbmQgPT09ICdpbml0Jykge1xuICAgICAgICAgICAgICAgIGlmICghaW5zdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgQ3VzdG9tU2Nyb2xsYmFyKGVsZW1lbnQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2VbY29tbWFuZF0pIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VbY29tbWFuZF0uYXBwbHkoaW5zdGFuY2UsIGFyZ3MpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBDb25uZWN0IGRlZmF1bHQgb3B0aW9ucyB0byBnbG9iYWwgb2JqZWN0XG4gICAgICovXG4gICAgJC5mbi5zY3JvbGxiYXIub3B0aW9ucyA9IGRlZmF1bHRzO1xuXG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiBzY3JvbGwgY29udGVudC9jb250YWluZXIgc2l6ZSBpcyBjaGFuZ2VkXG4gICAgICovXG5cbiAgICB2YXIgdXBkYXRlU2Nyb2xsYmFycyA9IChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciB0aW1lciA9IDAsXG4gICAgICAgICAgICB0aW1lckNvdW50ZXIgPSAwO1xuXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoZm9yY2UpIHtcbiAgICAgICAgICAgIHZhciBpLCBjb250YWluZXIsIG9wdGlvbnMsIHNjcm9sbCwgd3JhcHBlciwgc2Nyb2xseCwgc2Nyb2xseTtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBicm93c2VyLnNjcm9sbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBzY3JvbGwgPSBicm93c2VyLnNjcm9sbHNbaV07XG4gICAgICAgICAgICAgICAgY29udGFpbmVyID0gc2Nyb2xsLmNvbnRhaW5lcjtcbiAgICAgICAgICAgICAgICBvcHRpb25zID0gc2Nyb2xsLm9wdGlvbnM7XG4gICAgICAgICAgICAgICAgd3JhcHBlciA9IHNjcm9sbC53cmFwcGVyO1xuICAgICAgICAgICAgICAgIHNjcm9sbHggPSBzY3JvbGwuc2Nyb2xseDtcbiAgICAgICAgICAgICAgICBzY3JvbGx5ID0gc2Nyb2xsLnNjcm9sbHk7XG4gICAgICAgICAgICAgICAgaWYgKGZvcmNlIHx8IChvcHRpb25zLmF1dG9VcGRhdGUgJiYgd3JhcHBlciAmJiB3cmFwcGVyLmlzKCc6dmlzaWJsZScpICYmXG4gICAgICAgICAgICAgICAgICAgIChjb250YWluZXIucHJvcCgnc2Nyb2xsV2lkdGgnKSAhPSBzY3JvbGx4LnNpemUgfHwgY29udGFpbmVyLnByb3AoJ3Njcm9sbEhlaWdodCcpICE9IHNjcm9sbHkuc2l6ZSB8fCB3cmFwcGVyLndpZHRoKCkgIT0gc2Nyb2xseC52aXNpYmxlIHx8IHdyYXBwZXIuaGVpZ2h0KCkgIT0gc2Nyb2xseS52aXNpYmxlKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsLmluaXQoKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5kZWJ1Zykge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUgJiYgY29uc29sZS5sb2coe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbEhlaWdodDogY29udGFpbmVyLnByb3AoJ3Njcm9sbEhlaWdodCcpICsgJzonICsgc2Nyb2xsLnNjcm9sbHkuc2l6ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxXaWR0aDogY29udGFpbmVyLnByb3AoJ3Njcm9sbFdpZHRoJykgKyAnOicgKyBzY3JvbGwuc2Nyb2xseC5zaXplLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGVIZWlnaHQ6IHdyYXBwZXIuaGVpZ2h0KCkgKyAnOicgKyBzY3JvbGwuc2Nyb2xseS52aXNpYmxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2libGVXaWR0aDogd3JhcHBlci53aWR0aCgpICsgJzonICsgc2Nyb2xsLnNjcm9sbHgudmlzaWJsZVxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lckNvdW50ZXIrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkZWJ1ZyAmJiB0aW1lckNvdW50ZXIgPiAxMCkge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlICYmIGNvbnNvbGUubG9nKCdTY3JvbGwgdXBkYXRlcyBleGNlZWQgMTAnKTtcbiAgICAgICAgICAgICAgICB1cGRhdGVTY3JvbGxiYXJzID0gZnVuY3Rpb24gKCkge307XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KHVwZGF0ZVNjcm9sbGJhcnMsIDMwMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfSkoKTtcblxuICAgIC8qIEFERElUSU9OQUwgRlVOQ1RJT05TICovXG4gICAgLyoqXG4gICAgICogR2V0IG5hdGl2ZSBicm93c2VyIHNjcm9sbGJhciBzaXplIChoZWlnaHQvd2lkdGgpXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGFjdHVhbCBzaXplIG9yIENTUyBzaXplLCBkZWZhdWx0IC0gQ1NTIHNpemVcbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSB3aXRoIGhlaWdodCwgd2lkdGhcbiAgICAgKi9cbiAgICBmdW5jdGlvbiBnZXRCcm93c2VyU2Nyb2xsU2l6ZShhY3R1YWxTaXplKSB7XG5cbiAgICAgICAgaWYgKGJyb3dzZXIud2Via2l0ICYmICFhY3R1YWxTaXplKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGhlaWdodDogMCxcbiAgICAgICAgICAgICAgICB3aWR0aDogMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghYnJvd3Nlci5kYXRhLm91dGVyKSB7XG4gICAgICAgICAgICB2YXIgY3NzID0ge1xuICAgICAgICAgICAgICAgIFwiYm9yZGVyXCI6IFwibm9uZVwiLFxuICAgICAgICAgICAgICAgIFwiYm94LXNpemluZ1wiOiBcImNvbnRlbnQtYm94XCIsXG4gICAgICAgICAgICAgICAgXCJoZWlnaHRcIjogXCIyMDBweFwiLFxuICAgICAgICAgICAgICAgIFwibWFyZ2luXCI6IFwiMFwiLFxuICAgICAgICAgICAgICAgIFwicGFkZGluZ1wiOiBcIjBcIixcbiAgICAgICAgICAgICAgICBcIndpZHRoXCI6IFwiMjAwcHhcIlxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyb3dzZXIuZGF0YS5pbm5lciA9ICQoXCI8ZGl2PlwiKS5jc3MoJC5leHRlbmQoe30sIGNzcykpO1xuICAgICAgICAgICAgYnJvd3Nlci5kYXRhLm91dGVyID0gJChcIjxkaXY+XCIpLmNzcygkLmV4dGVuZCh7XG4gICAgICAgICAgICAgICAgXCJsZWZ0XCI6IFwiLTEwMDBweFwiLFxuICAgICAgICAgICAgICAgIFwib3ZlcmZsb3dcIjogXCJzY3JvbGxcIixcbiAgICAgICAgICAgICAgICBcInBvc2l0aW9uXCI6IFwiYWJzb2x1dGVcIixcbiAgICAgICAgICAgICAgICBcInRvcFwiOiBcIi0xMDAwcHhcIlxuICAgICAgICAgICAgfSwgY3NzKSkuYXBwZW5kKGJyb3dzZXIuZGF0YS5pbm5lcikuYXBwZW5kVG8oXCJib2R5XCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgYnJvd3Nlci5kYXRhLm91dGVyLnNjcm9sbExlZnQoMTAwMCkuc2Nyb2xsVG9wKDEwMDApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBoZWlnaHQ6IE1hdGguY2VpbCgoYnJvd3Nlci5kYXRhLm91dGVyLm9mZnNldCgpLnRvcCAtIGJyb3dzZXIuZGF0YS5pbm5lci5vZmZzZXQoKS50b3ApIHx8IDApLFxuICAgICAgICAgICAgd2lkdGg6IE1hdGguY2VpbCgoYnJvd3Nlci5kYXRhLm91dGVyLm9mZnNldCgpLmxlZnQgLSBicm93c2VyLmRhdGEuaW5uZXIub2Zmc2V0KCkubGVmdCkgfHwgMClcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiBuYXRpdmUgYnJvd3NlciBzY3JvbGxiYXJzIG92ZXJsYXkgY29udGVudFxuICAgICAqXG4gICAgICogQHJldHVybnMge0Jvb2xlYW59XG4gICAgICovXG4gICAgZnVuY3Rpb24gaXNTY3JvbGxPdmVybGF5c0NvbnRlbnQoKSB7XG4gICAgICAgIHZhciBzY3JvbGxTaXplID0gZ2V0QnJvd3NlclNjcm9sbFNpemUodHJ1ZSk7XG4gICAgICAgIHJldHVybiAhKHNjcm9sbFNpemUuaGVpZ2h0IHx8IHNjcm9sbFNpemUud2lkdGgpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGlzVmVydGljYWxTY3JvbGwoZXZlbnQpIHtcbiAgICAgICAgdmFyIGUgPSBldmVudC5vcmlnaW5hbEV2ZW50O1xuICAgICAgICBpZiAoZS5heGlzICYmIGUuYXhpcyA9PT0gZS5IT1JJWk9OVEFMX0FYSVMpXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmIChlLndoZWVsRGVsdGFYKVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIEV4dGVuZCBBbmd1bGFySlMgYXMgVUkgZGlyZWN0aXZlXG4gICAgICogYW5kIGV4cG9zZSBhIHByb3ZpZGVyIGZvciBvdmVycmlkZSBkZWZhdWx0IGNvbmZpZ1xuICAgICAqXG4gICAgICovXG4gICAgaWYgKHdpbmRvdy5hbmd1bGFyKSB7XG4gICAgICAgIChmdW5jdGlvbiAoYW5ndWxhcikge1xuICAgICAgICAgICAgYW5ndWxhci5tb2R1bGUoJ2pRdWVyeVNjcm9sbGJhcicsIFtdKVxuICAgICAgICAgICAgICAgIC5wcm92aWRlcignalF1ZXJ5U2Nyb2xsYmFyJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGVmYXVsdE9wdGlvbnMgPSBkZWZhdWx0cztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldE9wdGlvbnM6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5leHRlbmQoZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICRnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBhbmd1bGFyLmNvcHkoZGVmYXVsdE9wdGlvbnMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5kaXJlY3RpdmUoJ2pxdWVyeVNjcm9sbGJhcicsIFsnalF1ZXJ5U2Nyb2xsYmFyJywgJyRwYXJzZScsIGZ1bmN0aW9uIChqUXVlcnlTY3JvbGxiYXIsICRwYXJzZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN0cmljdDogXCJBQ1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsID0gJHBhcnNlKGF0dHJzLmpxdWVyeVNjcm9sbGJhciksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zID0gbW9kZWwoc2NvcGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNjcm9sbGJhcihvcHRpb25zIHx8IGpRdWVyeVNjcm9sbGJhci5vcHRpb25zKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm9uKCckZGVzdHJveScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnNjcm9sbGJhcignZGVzdHJveScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfV0pO1xuICAgICAgICB9KSh3aW5kb3cuYW5ndWxhcik7XG4gICAgfVxufSkpOyJdLCJmaWxlIjoibGlicy9qcXVlcnkuc2Nyb2xsYmFyLm1pbi5qcyJ9
